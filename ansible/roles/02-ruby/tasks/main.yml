---
# rbenv------------------------------------------------------------
- name: Check if git is installed
  command: which git
  register: git_location
  changed_when: false
  ignore_errors: true
  
- name: check rbenv install
  shell: bash -lc "rbenv --version"
  register: check_rbenv_installed
  changed_when: no
  ignore_errors: yes
  
- name: Clone the Git sampleapp_repository
  ansible.builtin.git:
    repo: 'https://github.com/yuta-ushijima/raisetech-live8-sample-app.git'
    dest: "/home/{{ ansible_user }}/raisetech-live8-sample-app"
    #version: 'main'
    force: yes
# アプリをデプロイするために必要なdirectoryを作成しておく
- name: directory created
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - path: "{{ app_dir }}/tmp/pids"
      owner: "ec2-user"
      group: "ec2-user"
      mode: "775"
    - path: "{{ app_dir }}/tmp/sockets"
      owner: "ec2-user"
      group: "ec2-user"
      mode: "775"

- name: install rbenv
  git:
    repo: https://github.com/sstephenson/rbenv.git
    dest: /home/ec2-user/.rbenv
  when: check_rbenv_installed.failed

- name: Add rbenv to PATH
  lineinfile: 
    path: /home/ec2-user/.bash_profile
    line: 'export PATH="$HOME/.rbenv/bin:$PATH"'
  when: check_rbenv_installed.failed

- name: eval rbenv init
  lineinfile: 
    path: /home/ec2-user/.bash_profile
    line: 'eval "$(rbenv init -)"'
  when: check_rbenv_installed.failed
  
- name: load .bash_profile
  shell: bash -lc "source ~/.bash_profile"
  when: check_rbenv_installed.failed

# ruby------------------------------------------------------------
- name: install ruby-build
  git:
    repo: https://github.com/sstephenson/ruby-build.git
    dest: /home/ec2-user/.rbenv/plugins/ruby-build
  when: check_rbenv_installed.failed

- name: install ruby
  shell: bash -lc "rbenv install {{ ruby_version }}"
  when: check_rbenv_installed.failed

- name: rehash rbenv
  shell: bash -lc "rbenv rehash"
  when: check_rbenv_installed.failed

- name: set default ruby version
  shell: bash -lc "rbenv global {{ ruby_version }}"
  when: check_rbenv_installed.failed