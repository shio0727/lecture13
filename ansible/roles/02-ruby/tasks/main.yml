---
- name: Install required packages for RVM
  apt:
    name: 
      - curl
      - gpg
      - gnupg2
      - build-essential
      - libssl-dev
      - libreadline-dev
      - zlib1g-dev
    state: present
  become: yes

- name: Import GPG keys
  shell: |
    command curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -
    command curl -sSL https://rvm.io/pkuczynski.asc | gpg2 --import -
  args:
    executable: /bin/bash
  become: yes

- name: Install RVM
  shell: |
    curl -L get.rvm.io | bash -s stable
  args:
    executable: /bin/bash
  become: yes

- name: Source RVM scripts
  shell: |
    source /etc/profile.d/rvm.sh
  args:
    executable: /bin/bash
  become: yes

- name: Get latest RVM version
  shell: |
    source /etc/profile.d/rvm.sh && rvm get head
  args:
    executable: /bin/bash
  become: yes

- name: Install Ruby version 3.2.3
  shell: |
    source /etc/profile.d/rvm.sh && rvm install 3.2.3
  args:
    executable: /bin/bash
  become: yes

- name: Set Ruby 3.2.3 as default
  shell: |
    source /etc/profile.d/rvm.sh && rvm --default use 3.2.3
  args:
    executable: /bin/bash
  become: yes

- name: Ensure RVM is loaded on login
  lineinfile:
    path: /home/ec2-user/.bashrc
    line: 'source ~/.rvm/scripts/rvm'
    create: yes
  become: yes

- name: Verify Ruby installation
  shell: |
    source /etc/profile.d/rvm.sh && ruby -v
  args:
    executable: /bin/bash
